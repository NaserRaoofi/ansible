---
# ğŸ­ ENTERPRISE DEPLOYMENT PLAYBOOK
# Real-world production deployment with advanced patterns
# Usage: ansible-playbook -i inventories/production/hosts playbooks/site.yml

- name: "ğŸ¯ Enterprise Production Deployment"
  hosts: all
  gather_facts: yes
  serial: "{{ deployment_batch_size | default('20%') }}"
  max_fail_percentage: 10
  
  # ============================================================================
  # ğŸ“‹ PRE-DEPLOYMENT VALIDATION
  # ============================================================================
  pre_tasks:
    - name: "ğŸ” Validate Environment Configuration"
      assert:
        that:
          - environment.name is defined
          - environment.name == "production"
          - ansible_os_family == "RedHat"
          - ansible_memtotal_mb >= 1024
        fail_msg: "âŒ Environment validation failed"
        success_msg: "âœ… Environment validation passed"
      tags: [validation, pre-deployment]
      
    - name: "ğŸ“Š Display Deployment Information"
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                 ENTERPRISE DEPLOYMENT INFO                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ¯ DEPLOYMENT DETAILS:
          ğŸ“± Application: {{ application.name }}
          ğŸ“¦ Version: {{ application.version }}
          ğŸŒ Environment: {{ environment.name | upper }}
          ğŸ·ï¸  Region: {{ environment.region }}
          ğŸ›ï¸  Strategy: {{ application.deployment.strategy | upper }}
          
          ğŸ–¥ï¸  SERVER DETAILS:
          ğŸ·ï¸  Hostname: {{ inventory_hostname }}
          ğŸ¯ Server ID: {{ server_id | default('N/A') }}
          ğŸ“ AZ: {{ az | default('N/A') }}
          ğŸ­ Role: {{ tier | default('general') }}
          ğŸ’¾ RAM: {{ ansible_memtotal_mb }}MB
          ğŸ§  CPU: {{ ansible_processor_cores }} cores
          
          ğŸ” SECURITY STATUS:
          ğŸ›¡ï¸  Firewall: {{ security.firewall.enabled | ternary('âœ… Enabled', 'âŒ Disabled') }}
          ğŸ”’ SSL: {{ 'webservers' in group_names and nginx.ssl is defined | ternary('âœ… Enabled', 'N/A') }}
          ğŸ“Š Monitoring: {{ monitoring.enabled | ternary('âœ… Enabled', 'âŒ Disabled') }}
          ğŸ’¾ Backup: {{ backup.enabled | ternary('âœ… Enabled', 'âŒ Disabled') }}
          
      tags: [info, deployment]
      
    - name: "â±ï¸ Record Deployment Start Time"
      set_fact:
        deployment_start_time: "{{ ansible_date_time.iso8601 }}"
        deployment_id: "{{ ansible_date_time.epoch }}-{{ inventory_hostname }}"
      tags: [deployment, metrics]

  # ============================================================================
  # ğŸ­ ROLE-BASED DEPLOYMENT
  # ============================================================================  
  tasks:
    - name: "ğŸŒ Deploy Web Servers"
      include_tasks: tasks/deploy-webserver.yml
      when: "'webservers' in group_names"
      tags: [webserver, deployment]
      
    - name: "ğŸ—„ï¸ Deploy Database Servers"
      include_tasks: tasks/deploy-database.yml
      when: "'databases' in group_names"
      tags: [database, deployment]
      
    - name: "ğŸ“Š Deploy Monitoring Stack"
      include_tasks: tasks/deploy-monitoring.yml
      when: "'monitoring' in group_names"
      tags: [monitoring, deployment]
      
    - name: "âš–ï¸ Deploy Load Balancers"
      include_tasks: tasks/deploy-loadbalancer.yml
      when: "'loadbalancers' in group_names"
      tags: [loadbalancer, deployment]

    # ============================================================================
    # ğŸ”§ CONFIGURATION MANAGEMENT
    # ============================================================================
    - name: "ğŸ”§ Apply Security Hardening"
      include_tasks: tasks/security-hardening.yml
      tags: [security, hardening]
      
    - name: "ğŸ“Š Configure Monitoring"
      include_tasks: tasks/configure-monitoring.yml
      when: monitoring.enabled | default(false)
      tags: [monitoring, configuration]
      
    - name: "ğŸ’¾ Configure Backup"
      include_tasks: tasks/configure-backup.yml
      when: backup.enabled | default(false)
      tags: [backup, configuration]

    # ============================================================================
    # ğŸ§ª DEPLOYMENT VALIDATION
    # ============================================================================
    - name: "ğŸ§ª Health Check - Service Status"
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop: "{{ required_services | default([]) }}"
      register: service_status
      tags: [validation, health-check]
      
    - name: "ğŸŒ Health Check - HTTP Endpoints"
      uri:
        url: "http://{{ ansible_default_ipv4.address }}{{ item.path }}"
        method: GET
        status_code: "{{ item.expected_status | default(200) }}"
        timeout: 10
      loop: "{{ health_check_endpoints | default([]) }}"
      when: "'webservers' in group_names"
      tags: [validation, health-check]
      
    - name: "ğŸ“Š Collect Deployment Metrics"
      set_fact:
        deployment_metrics:
          deployment_id: "{{ deployment_id }}"
          start_time: "{{ deployment_start_time }}"
          end_time: "{{ ansible_date_time.iso8601 }}"
          hostname: "{{ inventory_hostname }}"
          server_id: "{{ server_id | default('unknown') }}"
          environment: "{{ environment.name }}"
          application_version: "{{ application.version }}"
          deployment_strategy: "{{ application.deployment.strategy }}"
          success: true
      tags: [metrics, deployment]

  # ============================================================================
  # ğŸ“‹ POST-DEPLOYMENT TASKS
  # ============================================================================
  post_tasks:
    - name: "ğŸ“Š Display Deployment Summary"
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                   DEPLOYMENT COMPLETED                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… DEPLOYMENT SUCCESS:
          ğŸ†” ID: {{ deployment_metrics.deployment_id }}
          â° Started: {{ deployment_metrics.start_time }}
          ğŸ Completed: {{ deployment_metrics.end_time }}
          ğŸ–¥ï¸  Server: {{ deployment_metrics.hostname }}
          ğŸ“¦ Version: {{ deployment_metrics.application_version }}
          
          ğŸ¯ NEXT STEPS:
          1. Monitor application logs: /var/log/{{ application.name }}
          2. Check monitoring dashboard: {{ monitoring_dashboard_url | default('N/A') }}
          3. Verify backup configuration
          4. Review security compliance
          
      tags: [summary, deployment]
      
    - name: "ğŸ“§ Send Deployment Notification"
      mail:
        to: "{{ notifications.email.deployment_list | default(['ops@company.com']) }}"
        subject: "âœ… Production Deployment Completed - {{ application.name }} v{{ application.version }}"
        body: |
          Deployment completed successfully:
          
          Environment: {{ environment.name | upper }}
          Application: {{ application.name }}
          Version: {{ application.version }}
          Server: {{ inventory_hostname }}
          Deployment ID: {{ deployment_metrics.deployment_id }}
          
          Health checks: PASSED
          Security: ENABLED
          Monitoring: ACTIVE
          Backup: CONFIGURED
          
          Deployment completed at: {{ deployment_metrics.end_time }}
      when: 
        - notifications.email.enabled | default(false)
        - deployment_metrics.success | default(false)
      tags: [notification, post-deployment]
      ignore_errors: yes

  # ============================================================================
  # ğŸ”¥ ERROR HANDLING
  # ============================================================================  
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
      when: "'webservers' in group_names"
      
    - name: restart mysql
      systemd:
        name: mysqld
        state: restarted
      when: "'databases' in group_names"
      
    - name: reload firewall
      systemd:
        name: firewalld
        state: reloaded

# ============================================================================
# ğŸ” DEPLOYMENT ROLLBACK PLAYBOOK (if needed)
# ============================================================================
- name: "ğŸ”„ Rollback Procedure (if deployment fails)"
  hosts: all
  gather_facts: no
  
  tasks:
    - name: "ğŸš¨ Deployment Rollback"
      debug:
        msg: |
          âš ï¸  ROLLBACK INITIATED
          
          To rollback this deployment:
          1. ansible-playbook -i inventories/production/hosts playbooks/rollback.yml
          2. Check application logs
          3. Notify team via Slack
          
      when: deployment_failed | default(false)
      tags: [rollback, emergency]
